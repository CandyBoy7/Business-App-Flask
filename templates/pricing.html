{% extends "base.html" %}

{% block title %}ì„œë¹„ìŠ¤ ê°€ê²© ì •ì±…{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="text-center mb-4">ì„œë¹„ìŠ¤ ê°€ê²© ì •ì±…</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white text-center">
                    <h2 class="h4 mb-0">í”„ë¦¬ë¯¸ì—„ êµ¬ë… (ì›” 5000ì›)</h2>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> í”„ë¡œì íŠ¸ ìƒì„± ê°œìˆ˜ ë¬´ì œí•œ</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> ëª¨ë“  ì—…ë¬´ ê´€ë¦¬ ê¸°ëŠ¥ ì ‘ê·¼</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> ì¬ë°œê¸‰ë°›ì„ í•„ìš” ì—†ëŠ” ì•ˆì „í•˜ê³  í¸ë¦¬í•œ ì„œë¹„ìŠ¤</li>
                    </ul>

                    {% if current_user.is_authenticated and current_user.is_premium %}
                        <div class="alert alert-info text-center mt-4">
                            <p class="mb-1">ğŸ‰ í˜„ì¬ í”„ë¦¬ë¯¸ì—„ êµ¬ë…ìì…ë‹ˆë‹¤!</p>
                            <p class="mb-0">ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼: <strong>{{ current_user.subscription_expires.strftime('%Yë…„ %mì›” %dì¼') }}</strong></p>
                        </div>
                    {% elif current_user.is_authenticated %}
                        <div class="d-grid gap-2 mt-4">
                            <button id="payment-button" class="btn btn-primary btn-lg" onclick="requestPay()">
                                5000ì› êµ¬ë… ì‹œì‘í•˜ê¸°
                            </button>
                        </div>
                    {% else %}
                        <div class="alert alert-warning text-center mt-4">
                            <p class="mb-0">ë¡œê·¸ì¸ í›„ êµ¬ë…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            <a href="{{ url_for('login') }}" class="btn btn-sm btn-outline-primary mt-2">ë¡œê·¸ì¸ í•˜ê¸°</a>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer text-center text-muted">
                    <small>ê²°ì œëŠ” ì›” ë‹¨ìœ„ë¡œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤. ì–¸ì œë“ ì§€ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <a href="{{ url_for('index') }}" class="btn btn-sm btn-link">ëŒì•„ê°€ê¸°</a>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_authenticated and not current_user.is_premium %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<script>
    // ì•„ì„í¬íŠ¸ ì„¤ì •ì€ Flaskì—ì„œ ë„˜ê²¨ì¤€ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const IAMPORT_CONFIG = {
        imp_key: "{{ iamport_config['imp_key'] }}",
        nicepay_mid: "{{ iamport_config['nicepay_mid'] }}",
        payment_amount: {{ iamport_config['payment_amount'] }}
    };

    // Flaskì˜ current_user ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const USER_INFO = {
        email: "{{ user_email }}",
        name: "{{ user_name }}"
    };
    
    // ê³ ê° ê³ ìœ  ID (ë¹Œë§í‚¤ ì €ì¥ì— ì‚¬ìš©)
    const CUSTOMER_UID = "user_{{ current_user.id }}_{{ current_user.email | replace('@', '_') | replace('.', '-') }}";


    function requestPay() {
        if (IAMPORT_CONFIG.imp_key === "REST_API_Keyë¥¼_ì—¬ê¸°ì—_ì…ë ¥í•˜ì„¸ìš”") {
            alert("âš ï¸ ì•„ì„í¬íŠ¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹¤ì œ ê²°ì œ ì—°ë™ì€ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. app.pyì˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            return;
        }

        var IMP = window.IMP; 
        IMP.init(IAMPORT_CONFIG.imp_key); // ì•„ì„í¬íŠ¸ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë°œê¸‰ë°›ì€ "ê°€ë§¹ì  ì‹ë³„ì½”ë“œ"

        // merchant_uidëŠ” ë§¤ë²ˆ ê³ ìœ í•´ì•¼ í•©ë‹ˆë‹¤.
        var merchant_uid = 'MUID_' + new Date().getTime();

        IMP.request_pay({
            pg: 'nice.{}'.replace('nice.{}'.slice(5), IAMPORT_CONFIG.nicepay_mid), // PGì‚¬ ì„¤ì • (ë‚˜ì´ìŠ¤í˜ì´ ì‚¬ìš©)
            pay_method: 'card', 
            merchant_uid: merchant_uid, // ìƒì  ê±°ë˜ ID
            name: 'ìœ ë£Œ ë¹„ì¦ˆë‹ˆìŠ¤ ì•± í”„ë¦¬ë¯¸ì—„ êµ¬ë…',
            amount: IAMPORT_CONFIG.payment_amount, // ê²°ì œ ê¸ˆì•¡ (5000ì›)
            buyer_email: USER_INFO.email,
            buyer_name: USER_INFO.name,
            customer_uid: CUSTOMER_UID, // âš ï¸ ë¹Œë§í‚¤ ì €ì¥ì„ ìœ„í•œ ê³ ìœ  ì‹ë³„ì (í•„ìˆ˜)
            m_redirect_url: "{{ url_for('payment_callback', _external=True) }}", // ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ì‚¬ìš©
            
        }, function (rsp) {
            // ê²°ì œ ìš”ì²­ í›„ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜
            if (rsp.success) {
                // Flask ë°±ì—”ë“œ ì„œë²„ë¡œ ê²°ì œ ì •ë³´ë¥¼ ì „ì†¡í•˜ì—¬ ê²€ì¦ ë° ë¹Œë§í‚¤ ì €ì¥
                $.ajax({
                    url: "{{ url_for('payment_callback') }}",
                    method: 'POST',
                    data: {
                        imp_uid: rsp.imp_uid,
                        customer_uid: CUSTOMER_UID, // ë¹Œë§í‚¤ ì €ì¥ì„ ìœ„í•´ í•¨ê»˜ ì „ì†¡
                        success: true
                    },
                    success: function(data) {
                        // ì„œë²„ ì‘ë‹µì— ë”°ë¼ ë¦¬ë””ë ‰ì…˜ ì²˜ë¦¬
                        window.location.href = data.redirect || "{{ url_for('list_projects') }}";
                    },
                    error: function() {
                        alert('ê²°ì œ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                        window.location.href = "{{ url_for('pricing') }}";
                    }
                });
            } else {
                // ê²°ì œ ì‹¤íŒ¨ ì‹œ
                alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë‚´ìš©: " + rsp.error_msg);
                // ì‹¤íŒ¨ ì •ë³´ë¥¼ ì„œë²„ì— ì „ì†¡ (ì„ íƒ ì‚¬í•­)
                $.ajax({
                    url: "{{ url_for('payment_callback') }}",
                    method: 'POST',
                    data: {
                        imp_uid: rsp.imp_uid || 'N/A',
                        customer_uid: CUSTOMER_UID,
                        success: false
                    }
                });
                window.location.href = "{{ url_for('pricing') }}";
            }
        });
    }
</script>
{% endif %}
{% endblock %}